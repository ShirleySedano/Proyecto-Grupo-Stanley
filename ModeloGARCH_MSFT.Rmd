---
title: "Modelos VAR"
author: "Shirley Sanchez"
output: html_document
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
##Librerias

library(quantmod)
library(ggplot2)
library(dygraphs)
library(dplyr)
library(xts)
library(ggcorrplot)
library(tidyverse)
library(lubridate)
library(tseries)
library(tsoutliers)
library(tsbox)
library(forecast)
library(data.table)
library(ggcorrplot)
library(TSstudio)
library(fImport)
library(vars)

```

### Modelo GARCH- MSFT

### Creacion de la base

```{r,echo=FALSE,message=FALSE,warning=FALSE}
nombreAcciones<-c("MSFT")
acciones<-getSymbols(nombreAcciones, src = "yahoo", from = "2012-05-18", to = "2023-03-01", periodicity = "daily")
```

```{r,echo=FALSE, message=FALSE,warning=FALSE}

CierreAjustado<- cbind(MSFT$MSFT.Adjusted)

tail(CierreAjustado)
```

### Calcular los retornos diarios

```{r,echo=FALSE,message=FALSE,warning=FALSE}
Rendimientos<-(periodReturn(CierreAjustado$MSFT.Adjusted, period = "daily",type="log")*100)
```

### Pasar a dataframe

```{r,echo=FALSE,message=FALSE,warning=FALSE}
Rendimientos_MSFT<-data.frame(Rendimientos)
Rendimientos_MSFT$Date<-as.Date(rownames(Rendimientos_MSFT))
```

### Pasar a formato xts

```{r,echo=FALSE,message=FALSE,warning=FALSE}
RendimientosTS<-xts(Rendimientos_MSFT[,-2], order.by=Rendimientos_MSFT$Date)

```

### Graficando

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}
dygraph(RendimientosTS, main = "Rendimiento de MSFT") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(20, "Set2"))%>%
  dyAxis("y",label = "Rendimiento")%>%
  dyAxis("x",label = "Año") %>%
  dyLegend(dygraph, show = c("onmouseover"), width = 150) %>%
  dyRangeSelector()

```
### Conjunto de prueba y entrenamiento

```{r,echo=FALSE,message=FALSE,warning=FALSE}

BaseEntrenamiento<-RendimientosTS[c(seq(1,2200)),]
BasePrueba<-RendimientosTS[c(seq(2201,nrow(RendimientosTS))),]

```


### Calcular el modelo para la media

```{r,echo=FALSE,message=FALSE,warning=FALSE}
modelo1<-auto.arima(BaseEntrenamiento)
summary(modelo1)

##ARMA(1,0) con media diferente de cero
```
```{r,echo=FALSE,message=FALSE}
autoplot(modelo1)

##Revisando residuales del modelo
checkresiduals(modelo1)

```

### Calcular los residuales al cuadrado

```{r,echo=FALSE,message=FALSE,warning=FALSE}

Errores_cuadrado = resid(modelo1)^2

chartSeries(Errores_cuadrado)

```

### Calcular pacf de los residuales al cuadrado

```{r,echo=FALSE,message=FALSE,warning=FALSE}
pacf(Errores_cuadrado)
### Se observa que los primeros 10 rezagos son importantes
```

### Verificar efectos ARCH

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(dynlm)
Regresion1 = dynlm(Errores_cuadrado ~L(Errores_cuadrado,1)+L(Errores_cuadrado,2)+L(Errores_cuadrado,3)+L(Errores_cuadrado,4)+L(Errores_cuadrado,5)+L(Errores_cuadrado,6)+L(Errores_cuadrado,7)+L(Errores_cuadrado,8)+ L(Errores_cuadrado,9)+L(Errores_cuadrado,10))

summary(Regresion1)

```

Se observa que despues del 2 rezago deja de ser significativo, por lo tanto solo se tomará 2

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#H0: No hay efectos ARCH si el p-value es mayor que 0.05
#H1: Sí hay efectos ARCH si el p-value es menor que 0.05
#Conclusión: Sí hay efectos ARCH con 2 rezagos

Regresion2 = dynlm(Errores_cuadrado ~L(Errores_cuadrado,1)+L(Errores_cuadrado,2))

summary(Regresion2)

```

### También existe otra prueba ARCH para verificar

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(FinTS)
ModeloARCH1 = ArchTest(BaseEntrenamiento, lags = 2, demean = TRUE)

ModeloARCH1 ### Se comprueba efectos arch
```
### Generar el modelo GARCH(1,1)+ARMA(0,1)

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(fGarch)
ugarch1 = ugarchspec(mean.model = list(armaOrder = c(1,0),include.mean = TRUE),variance.model = list(garchOrder=c(1,1)))

ugfit = ugarchfit(spec = ugarch1, data = BaseEntrenamiento)
ugfit

#Alpha1: coeficiente de los residuales al cuadrado SON SIGNIFICATIVOS
#Beta1: coeficiente de la varianza al cuadrado con un rezago SON SIGNIFICATIVOS

```




### Simulacion basica GARCH

```{r,echo=FALSE,message=FALSE,warning=FALSE}
##Simulacion
garch11.sim = ugarchsim(ugfit, n.sim=512, rseed=111)

## Pasar a data frame
BasePrueba<-as.data.frame(BasePrueba)
BasePrueba$Date<-as.Date(rownames(BasePrueba))
simulacion<-data.frame(garch11.sim@simulation$seriesSim)
colnames(simulacion)<-c("simulacion")


```
```{r,echo=FALSE,message=FALSE,warning=FALSE}
BaseT<-data.frame(Date=BasePrueba$Date,Real=BasePrueba$V1,Pronostico=simulacion$simulacion)

BaseTS<-xts(BaseT[-1],order.by = BaseT$Date)
```



```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}
dygraph(BaseTS[,1:2], main = "Rendimientos Accion Microsoft-Base Test") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(20, "Set2"))%>%
  dyAxis("y",label = "Rendimiento Logaritmico")%>%
  dyAxis("x",label = "Año") %>%
  dyLegend(dygraph, show = c("onmouseover"), width = 150) %>%
  dyRangeSelector()

```

###Metricas

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(MLmetrics)


###Metricas
RMSE(simulacion$simulacion,BasePrueba$V1)
R2_Score(simulacion$simulacion,BasePrueba$V1)
MAE(simulacion$simulacion,BasePrueba$V1)


```

### Dejando unicamente 20 datos de prueba


### Conjunto de prueba y entrenamiento

```{r,echo=FALSE,message=FALSE,warning=FALSE}

BaseEntrenamiento<-RendimientosTS[c(seq(1,2692)),]
BasePrueba<-RendimientosTS[c(seq(2693,nrow(RendimientosTS))),]

```


### Calcular el modelo para la media

```{r,echo=FALSE,message=FALSE,warning=FALSE}
modelo1<-auto.arima(BaseEntrenamiento)
summary(modelo1)

##ARMA(0,1) con media diferente de cero
```
```{r,echo=FALSE,message=FALSE}
autoplot(modelo1)

##Revisando residuales del modelo
checkresiduals(modelo1)

```

### Calcular los residuales al cuadrado

```{r,echo=FALSE,message=FALSE,warning=FALSE}

Errores_cuadrado = resid(modelo1)^2

chartSeries(Errores_cuadrado)

```

### Calcular pacf de los residuales al cuadrado

```{r,echo=FALSE,message=FALSE,warning=FALSE}
pacf(Errores_cuadrado)
### Se observa que los primeros 10 rezagos son importantes
```

### Verificar efectos ARCH

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(dynlm)
Regresion1 = dynlm(Errores_cuadrado ~L(Errores_cuadrado,1)+L(Errores_cuadrado,2)+L(Errores_cuadrado,3)+L(Errores_cuadrado,4)+L(Errores_cuadrado,5)+L(Errores_cuadrado,6)+L(Errores_cuadrado,7)+L(Errores_cuadrado,8)+ L(Errores_cuadrado,9)+L(Errores_cuadrado,10))

summary(Regresion1)

```

Se observa que despues del 2 rezago deja de ser significativo, por lo tanto solo se tomará 2

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#H0: No hay efectos ARCH si el p-value es mayor que 0.05
#H1: Sí hay efectos ARCH si el p-value es menor que 0.05
#Conclusión: Sí hay efectos ARCH con 2 rezagos

Regresion2 = dynlm(Errores_cuadrado ~L(Errores_cuadrado,1)+L(Errores_cuadrado,2))

summary(Regresion2)

```

### También existe otra prueba ARCH para verificar

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(FinTS)
ModeloARCH1 = ArchTest(BaseEntrenamiento, lags = 2, demean = TRUE)

ModeloARCH1 ### Se comprueba efectos arch
```
### Generar el modelo GARCH(1,1)+ARMA(1,0)

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(fGarch)
ugarch1 = ugarchspec(mean.model = list(armaOrder = c(1,0),include.mean = TRUE),variance.model = list(garchOrder=c(1,1)))

ugfit = ugarchfit(spec = ugarch1, data = BaseEntrenamiento)
ugfit

#Alpha1: coeficiente de los residuales al cuadrado SON SIGNIFICATIVOS
#Beta1: coeficiente de la varianza al cuadrado con un rezago SON SIGNIFICATIVOS

```




### Simulacion basica GARCH

```{r,echo=FALSE,message=FALSE,warning=FALSE}
##Simulacion
garch11.sim = ugarchsim(ugfit, n.sim=20, rseed=111)

## Pasar a data frame
BasePrueba<-as.data.frame(BasePrueba)
BasePrueba$Date<-as.Date(rownames(BasePrueba))
simulacion<-data.frame(garch11.sim@simulation$seriesSim)
colnames(simulacion)<-c("simulacion")


```
```{r,echo=FALSE,message=FALSE,warning=FALSE}
BaseT<-data.frame(Date=BasePrueba$Date,Real=BasePrueba$V1,Pronostico=simulacion$simulacion)

BaseTS<-xts(BaseT[-1],order.by = BaseT$Date)
```



```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}
dygraph(BaseTS[,1:2], main = "Rendimientos Accion Microsoft-Base Test") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(20, "Set2"))%>%
  dyAxis("y",label = "Rendimiento Logaritmico")%>%
  dyAxis("x",label = "Año") %>%
  dyLegend(dygraph, show = c("onmouseover"), width = 150) %>%
  dyRangeSelector()

```

###Metricas

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(MLmetrics)


###Metricas
RMSE(simulacion$simulacion,BasePrueba$V1)
R2_Score(simulacion$simulacion,BasePrueba$V1)
MAE(simulacion$simulacion,BasePrueba$V1)


```













